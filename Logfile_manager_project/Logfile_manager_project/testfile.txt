#include <iostream>
#include <string>
#include <vector>
#include <map>
#include <memory>
#include <fstream>
#include <filesystem>
#include <iomanip>
#include <chrono>
#include <ctime>

// ==========================================
// 1. LogFileManager 클래스 정의 (기존 .h 내용)
// ==========================================
class LogFileManager {
public:
    LogFileManager() = default;
    ~LogFileManager() = default;
     
    [cite_start]// 스마트 포인터 관리를 위해 복사 금지 설정 [cite: 32]
    LogFileManager(const LogFileManager&) = delete;
    LogFileManager& operator=(const LogFileManager&) = delete;

    void make_or_open_File(const std::string& filename);
    void write_File(const std::string& filename, const std::string& message);
    std::vector<std::string> readLogs(const std::string& filename);
    void close_File(const std::string& filename);
    void delete_File(const std::string& filename);
    void rename_File(const std::string& oldName, const std::string& newName);

private:
    [cite_start]// fstream을 unique_ptr로 관리하여 자원 안전성 확보 [cite: 27]
    std::map<std::string, std::unique_ptr<std::fstream>> logFiles;
};

// ==========================================
// 2. 클래스 메서드 구현 (기존 .cpp 내용)
// ==========================================
void LogFileManager::make_or_open_File(const std::string& filename) {
    if (logFiles.find(filename) == logFiles.end()) {
        logFiles[filename] = std::make_unique<std::fstream>(filename, std::ios::in | std::ios::out | std::ios::app);
        std::cout << "파일을 만들거나 열었습니다: " << filename << std::endl;
    }
}

void LogFileManager::write_File(const std::string& filename, const std::string& message) {
    auto it = logFiles.find(filename); 

    if (it != logFiles.end()) {
        [cite_start]// 현재 시간 기반 타임스탬프 생성 [cite: 24]
        auto now = std::chrono::system_clock::now();
        std::time_t now_c = std::chrono::system_clock::to_time_t(now);
        struct tm timeinfo;
        
        // Window 환경을 고려한 localtime_s 사용
        localtime_s(&timeinfo, &now_c);
      
        *(it->second) << "[" << std::put_time(&timeinfo, "%Y-%m-%d %H:%M:%S") << "] " << message << std::endl;
    }
}

std::vector<std::string> LogFileManager::readLogs(const std::string& filename) {
    std::vector<std::string> logs;
    std::ifstream file(filename);

    if (file.is_open()) {
        std::string line;
        while (std::getline(file, line)) {
            logs.push_back(line);
        }
        file.close();
    }
    return logs;
}

void LogFileManager::close_File(const std::string& filename) {
    if (logFiles.erase(filename)) {
        std::cout << "파일을 닫았습니다: " << filename << std::endl;
    }
}

void LogFileManager::delete_File(const std::string& filename) {
    logFiles.erase(filename); // 먼저 메모리에서 제거해 파일 핸들을 닫음
   
    if (std::filesystem::remove(filename)) {
        std::cout << "파일이 삭제되었습니다: " << filename << std::endl;
    }
    else {
        std::cout << "삭제할 파일이 없거나 실패했습니다." << std::endl;
    }
}

void LogFileManager::rename_File(const std::string& oldName, const std::string& newName) {
    auto it = logFiles.find(oldName);
    if (it == logFiles.end()) {
        std::cout << "변경할 파일이 목록에 없습니다." << std::endl;
        return;
    }
    logFiles.erase(it);

    std::error_code error_code;
    std::filesystem::rename(oldName, newName, error_code);

    if (!error_code) {
        std::cout << "이름 변경 성공: " << oldName << " > " << newName << std::endl;
        make_or_open_File(newName);
    }
    else {
        std::cout << "변경 실패: " << error_code.message() << std::endl;
        make_or_open_File(oldName);
    }
}

// ==========================================
// 3. 메인 실행부 (기존 _input.cpp 내용)
// ==========================================
int main() {
    LogFileManager manager;
    int choice = 0;
    std::string filename, message;

    while (true) {
        std::cout << "\n[메뉴] 1:파일만들기or열기, 2:텍스트쓰기, 3:전체읽기, 4:파일삭제, 5:파일이름변경, 6:종료\n";
        std::cout << "선택: ";
        std::cin >> choice;
        
        if (choice == 6) break;
        
        switch (choice) {
        case 1:
            std::cout << "파일만들기 or 열기 파일명(확장자필수): ";
            std::cin >> filename;
            manager.make_or_open_File(filename);
            break;
        case 2:
            std::cout << "텍스트쓰기 파일명: ";
            std::cin >> filename;
            std::cout << "텍스트 내용: ";
            std::cin.ignore(); 
            std::getline(std::cin, message);
            manager.write_File(filename, message);
            break; 
        case 3:
            std::cout << "읽을 파일명: ";
            std::cin >> filename;
            {
                std::vector<std::string> logs = manager.readLogs(filename);
                std::cout << "파일내용: [" << filename << "]\n";
                for (const auto& line : logs) {
                    std::cout << line << std::endl;
                }
            }
            break;
        case 4:
            std::cout << "삭제할 파일명: ";
            std::cin >> filename;
            manager.delete_File(filename);
            break;
        case 5:
        {
            std::string oldName, newName;
            std::cout << "변경할 현재 파일명: ";
            std::cin >> oldName;
            std::cout << "변경할 새로운 파일명: ";
            std::cin >> newName;
            manager.rename_File(oldName, newName);
        }
        break;
        default:
            std::cout << "잘못된 입력입니다.\n";
            break;
        }
    }

    std::cout << "프로그램을 종료합니다.\n";
    return 0;
}